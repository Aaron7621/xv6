# Memory

### kernel/vm.c

主要是和页表操作相关的代码。

1. walk()：获取va对应的pte。如果alloc入参为1且位于非叶子节点，则一路创建非叶子节点的页表。最后返回叶子节点中的PTE，也就是va对应的PTE，此时的PTE只是“找到对应的”，但是并未检查合法性和其中的值，可能是空的。当alloc参数为1时，当且仅当分配页表资源失败时才返回0
2. mappages：接收一段不一定对齐的虚拟地址与一个物理地址，及要映射的范围，把范围内所有虚拟页所对应的物理页都映射页表中，返回-1如果创建多级页表时资源分配失败。这个函数只涉及页表映射，不涉及实际资源的分配，即要先分配了资源，获得了pa，才能调用这个函数将映射登记到页表
3. uvmalloc：参数：页表、旧的size，新的size，如果新size大于旧size而且跨页了，那么分配所有包含的新的页。如果某一新页分配失败了，调用uvmdealloc将之前分配的新的页全部回收并返回；如果某一新页分配成功但是也表映射失败了，把那一页回收，同时把之前分配成功的新的页页全部回收并返回。
4.  uvmdealloc：主要调用uvmunmap回收页
5.  uvmunmap：解除一段连续的虚拟地址范围在页表中的叶子映射并且释放掉相应的物理资源。根据va是可以获得pa的，所以可以在这个函数中完成删映射+释放物理页。也可以通过参数指定不释放掉相应的物理页，只删除虚拟地址范围对应的PTE。
6. freewalk：在页表叶子节点已经被删除后才能调用，删除页表除了叶子节点以外的所有pte
7. uvmfree：先调用uvmunmap删除掉一段虚拟地址范围的【叶子PTE】与【对应PTE的物理页】，再通过freewalk删掉页表叶子节点以外的所有PTE